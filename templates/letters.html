<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Countdown Game - Letter Round</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
        button {
            margin: 10px;
            padding: 10px 20px;
            font-size: 16px;
        }
        #letters, #userWord, #result, #timer, #score, #round, #possibleWords, #highScores, #letterSelection {
            font-size: 24px;
            margin: 20px 0;
        }
        #timer {
            font-weight: bold;
            color: #d00;
        }
        #score, #round {
            font-weight: bold;
            color: #080;
        }
        #possibleWords, #highScores {
            max-width: 80%;
            text-align: center;
        }
        #highScores {
            border: 1px solid #ccc;
            padding: 10px;
            margin-top: 20px;
        }
        #letterSelection button {
            font-size: 18px;
            margin: 5px;
        }
    </style>
</head>
<body>
    <h1>Countdown Game - Letter Round</h1>
    <div id="round">Round: 1 / 3</div>
    <div id="timer">30</div>
    <div id="score">Score: 0</div>
    <div id="letterSelection">
        <button onclick="selectLetter('vowel')">Vowel</button>
        <button onclick="selectLetter('consonant')">Consonant</button>
    </div>
    <div id="letters"></div>
    <button onclick="startRound()" id="startButton" disabled>Start Round</button>
    <input type="text" id="userWord" placeholder="Enter your word" disabled>
    <button onclick="submitWord()" id="submitButton" disabled>Submit Word</button>
    <div id="result"></div>
    <div id="possibleWords"></div>
    <div id="highScores"></div>

    <script>
        const vowels = 'AEIOU';
        const consonants = 'BCDFGHJKLMNPQRSTVWXYZ';
        let currentLetters = '';
        let timerInterval;
        let timeLeft = 30;
        let score = 0;
        let currentRound = 0;
        const totalRounds = 3;
        let validWords = new Set();
        const wordCache = new Map();
        let letterCount = 0;

        function selectLetter(type) {
            if (letterCount < 9) {
                let letter;
                if (type === 'vowel') {
                    letter = vowels[Math.floor(Math.random() * vowels.length)];
                } else {
                    letter = consonants[Math.floor(Math.random() * consonants.length)];
                }
                currentLetters += letter;
                letterCount++;
                updateLettersDisplay();
                
                if (letterCount === 9) {
                    document.getElementById('startButton').disabled = false;
                    document.querySelectorAll('#letterSelection button').forEach(btn => btn.disabled = true);
                }
            }
        }

        function updateLettersDisplay() {
            document.getElementById('letters').textContent = currentLetters;
        }

        function startRound() {
            document.getElementById('startButton').disabled = true;
            document.getElementById('userWord').disabled = false;
            document.getElementById('submitButton').disabled = false;
            document.getElementById('result').textContent = '';
            document.getElementById('possibleWords').textContent = '';
            startTimer();
        }

        function startGame() {
            if (currentRound < totalRounds) {
                currentRound++;
                updateRoundDisplay();
                resetLetterSelection();
                document.getElementById('userWord').value = '';
                document.getElementById('startButton').textContent = 'Start Round';
                validWords.clear();
            } else {
                endGame(true);
            }
        }

        function resetLetterSelection() {
            currentLetters = '';
            letterCount = 0;
            updateLettersDisplay();
            document.querySelectorAll('#letterSelection button').forEach(btn => btn.disabled = false);
            document.getElementById('startButton').disabled = true;
        }

        function startTimer() {
            timeLeft = 30;
            updateTimerDisplay();
            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();
                if (timeLeft <= 0) {
                    endRound();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            document.getElementById('timer').textContent = timeLeft;
        }

        function endRound() {
            clearInterval(timerInterval);
            document.getElementById('userWord').disabled = true;
            document.getElementById('submitButton').disabled = true;
            if (timeLeft <= 0) {
                document.getElementById('result').textContent = 'Time\'s up!';
            }
            document.getElementById('startButton').disabled = false;
            document.getElementById('startButton').textContent = 'Next Round';
            if (currentRound === totalRounds) {
                document.getElementById('startButton').textContent = 'See Final Score';
            }
            displayPossibleWords();
        }

        async function submitWord() {
            const userWord = document.getElementById('userWord').value.toUpperCase();
            let isValid = await checkWordValidity(userWord);

            if (isValid) {
                const wordScore = calculateScore(userWord);
                score += wordScore;
                document.getElementById('result').textContent = `Valid word: ${userWord}. You scored ${wordScore} points!`;
                updateScoreDisplay();
                validWords.add(userWord);
            } else {
                document.getElementById('result').textContent = 'Invalid word. No points awarded.';
            }

            endRound();
        }

        async function checkWordValidity(word) {
            if (word.length < 3) return false;
            if (!canFormWord(word)) return false;
            return await validateWord(word);
        }

        function canFormWord(word) {
            let tempLetters = currentLetters;
            for (let char of word) {
                if (tempLetters.includes(char)) {
                    tempLetters = tempLetters.replace(char, '');
                } else {
                    return false;
                }
            }
            return true;
        }

        async function validateWord(word) {
            if (wordCache.has(word)) {
                return wordCache.get(word);
            }
            try {
                const response = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${word}`);
                const isValid = response.ok;
                wordCache.set(word, isValid);
                return isValid;
            } catch (error) {
                console.error('Error validating word:', error);
                return false;
            }
        }

        function calculateScore(word) {
            const length = word.length;
            if (length <= 4) return length;
            if (length === 5) return 5;
            if (length === 6) return 6;
            if (length === 7) return 7;
            if (length === 8) return 10;
            return 11; // 9 letters
        }

        function updateScoreDisplay() {
            document.getElementById('score').textContent = `Score: ${score}`;
        }

        function updateRoundDisplay() {
            document.getElementById('round').textContent = `Round: ${currentRound} / ${totalRounds}`;
        }

        function endGame(completed = false) {
            document.getElementById('startButton').disabled = true;
            document.getElementById('userWord').disabled = true;
            document.getElementById('submitButton').disabled = true;
            document.querySelectorAll('#letterSelection button').forEach(btn => btn.disabled = true);
            if (completed) {
                document.getElementById('result').textContent = `Game Over! Final Score: ${score}`;
                updateHighScores(score);
            }
        }

        async function findPossibleWords() {
            const words = [];
            for (let len = 9; len >= 3; len--) {
                const combinations = getCombinations(currentLetters, len);
                for (const word of combinations) {
                    if (await validateWord(word)) {
                        words.push(word);
                        if (words.length >= 10) return words;
                    }
                }
            }
            return words;
        }

        function getCombinations(letters, length) {
            const combinations = [];
            function backtrack(start, current) {
                if (current.length === length) {
                    combinations.push(current.join(''));
                    return;
                }
                for (let i = start; i < letters.length; i++) {
                    current.push(letters[i]);
                    backtrack(i + 1, current);
                    current.pop();
                }
            }
            backtrack(0, []);
            return combinations;
        }

        async function displayPossibleWords() {
            const possibleWordsElement = document.getElementById('possibleWords');
            possibleWordsElement.innerHTML = '<h3>Finding possible words...</h3>';
            const words = await findPossibleWords();
            const newWords = words.filter(word => !validWords.has(word));
            if (newWords.length > 0) {
                possibleWordsElement.innerHTML = '<h3>Some possible words you missed:</h3>' + newWords.join(', ');
            } else {
                possibleWordsElement.textContent = 'Great job! You found all the words we could find.';
            }
        }

        function updateHighScores(newScore) {
            let highScores = JSON.parse(localStorage.getItem('countdownHighScores')) || [];
            highScores.push(newScore);
            highScores.sort((a, b) => b - a);
            highScores = highScores.slice(0, 5); // Keep only top 5 scores
            localStorage.setItem('countdownHighScores', JSON.stringify(highScores));
            displayHighScores();
        }

        function displayHighScores() {
            const highScores = JSON.parse(localStorage.getItem('countdownHighScores')) || [];
            const highScoresElement = document.getElementById('highScores');
            if (highScores.length > 0) {
                let html = '<h3>High Scores:</h3><ol>';
                highScores.forEach(score => {
                    html += `<li>${score}</li>`;
                });
                html += '</ol>';
                highScoresElement.innerHTML = html;
            } else {
                highScoresElement.textContent = 'No high scores yet. Be the first!';
            }
        }

        // Initialize game
        startGame();
        displayHighScores();
    </script>
</body>
</html>